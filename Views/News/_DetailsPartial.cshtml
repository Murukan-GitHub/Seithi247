@model Seithi247.Views.ViewModel.NewsVM
@{
    Layout = null;
}
<head>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/partialdetails.css" />
    <script src="~/js/news.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@fancyapps/ui/dist/fancybox.css" />

    <style>

        /* Entire media container */
        .media-section {
            width: 100%;
            margin-top: 20px;
        }

        /* ---------- IMAGE GALLERY ---------- */
        .gallery {
            column-count: 3;
            column-gap: 12px;
        }

            .gallery a {
                display: block;
                margin-bottom: 12px;
                border-radius: 10px;
                overflow: hidden;
            }

        .gallery-img {
            width: 100%;
            border-radius: 10px;
            transition: transform 0.25s ease, opacity 0.25s;
            background: #111;
        }

            .gallery-img:hover {
                transform: scale(1.05);
                opacity: 0.9;
            }
        /* ---------- VIDEO SECTION ---------- */
        .video-section {
            margin-top: 20px;
        }

        .video-wrapper {
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

            /* Responsive video */
            .video-wrapper video {
                width: 80%;
                height: auto;
                display: block;
                border-radius: 12px;
            }

        /* ---------- MOBILE RESPONSIVENESS ---------- */
        @@media (max-width: 768px) {
            .gallery {
                column-count: 2;
                column-gap: 10px;
            }
        }

        @@media (max-width: 576px) {
            .gallery {
                column-count: 1;
            }

            .gallery-img {
                border-radius: 8px;
            }

            .video-wrapper {
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
    <script>
        //  $('[data-fancybox="details"]').fancybox({
        //     type: 'ajax',
        //     autoSize: true,
        //     iframe: false,
        //     toolbar: false,
        //     smallBtn: true,
        //     baseClass: 'news-post-popup',
        //     trapFocus: false,
        //     touch: false,
        //     afterLoad: function (instance, slide) {
        //         alert("D");
        //         slide.$content.addClass('/css/partialdetails.css');
        //     }
        // });


        //             function initNewsDetailInteractions() {
        //         // ensure our popup CSS is loaded into the parent <head>
        //           const href = '/css/partialdetails.css'; // absolute path to your CSS
        //           if (!document.querySelector(`link[href="${href}"]`)) {
        //             const link = document.createElement('link');
        //             link.rel = 'stylesheet';
        //             link.href = href;
        //             link.id = 'partialdetails';
        //             document.head.appendChild(link);
        //             // optional: wait until CSS loads, then update Fancybox
        //             link.onload = () => fbox.update();
        //           } else {
        //             // already loaded, just update layout
        //             fbox.update();
        //           }
        //           }


                 $(document).on("click", ".react-btn", function () {
                     alert('f');
                     var commentId = $(this).data("comment");
                     var emoji = $(this).data("emoji");
                     $.post("/News/ReactToComment", { commentId, emoji }, function (data) {
                         let summaryText = data.map(r => `${r.emoji} ${r.count}`).join(" ");
                         $("#reaction-summary-" + commentId).text(summaryText);
                     }).fail(function () {
                         alert("Error reacting to comment.");
                     });
                 });


                  //  $(document).on("click", ".post-comment", function (e) {
                  //       e.preventDefault();

                  //       let id = $(this).data("id");
                  //       let comment = $("#commentText").val();
                  //       let auth =$("#authorName").val();
                  //       console.log(comment);
                  //       console.log(auth);
                  //       $.post("/News/AddComment", { newsId: id,authorName :auth, text: comment ,reaction:""}, function (res) {

                  //           $("#comments-list").html(res);
                  //             $("#commentText").val("");
                  //             $("#authorName").val("");
                  //       });
                  // });

                // $(document).off("click", ".like-btn").on("click", ".like-btn", function (e) {
                //     e.preventDefault();
                //     alert("d");
                //     const id = $(this).data("id");
                //       $.post("/News/Like", { id: id }, function (res) {
                //         $(".like-count").text(res.likes);
                //     });
                // });

        //         $(document).off("click", ".post-comment").on("click", ".post-comment", function (e) {
        //             e.preventDefault();
        //             alert("dff");
        // let id = $(this).data("id");

        // let comment = $(`#commentText[data-id='${id}']`).val();
        // let author  = $(`#authorName[data-id='${id}']`).val();

        // console.log(comment);
        //                         console.log(author);
        //                 $.post("/News/AddComment", { newsId: id,authorName :author, text: comment ,reaction:""}, function (res) {

        //                     $("#comments-list").html(res);
        //                       $("#commentText").text("");
        //                       $("#authorName").text("");
        //                 });
        //         });


        /* SHARE */
        function shareFB(id) {
            window.open("https://www.facebook.com/sharer/sharer.php?u=" + location.origin + "/News/Details/" + id);
        }
        function shareWA(id) {
            window.open("https://wa.me/?text=" + encodeURIComponent(location.origin + "/News/Details/" + id));
        }
        function shareTW(id) {
            window.open("https://twitter.com/intent/tweet?url=" + location.origin + "/News/Details/" + id);
        }

    </script>

</body>

<div class="popup-container" position-relative">
    <div class="popup-left">
        <div class="news-header">
            <h2>@Model.Title</h2>
            <div class="newsheader-label">
            <p class="meta">
                @Model.NewsCategory.ToString()•@Model.Country.ToString()
            </p>
            </div>
        </div>

        <div class="news-actions">
            <button class="like-btn" data-id="@Model.Id">
                👍 Like (<span class="like-count">@Model.Likes</span>)
            </button>
@*             <!-- FLOATING LIKE BUTTON -->
            <div class="floating-like" id="likeBtn" data-id="@Model.Id">❤️</div> *@
            <!-- SHARE -->
            <div class="share-buttons mt-3">
                <button onclick="shareFB('@Model.Id')">Facebook</button>
                <button onclick="shareWA('@Model.Id')">WhatsApp</button>
                <button onclick="shareTW('@Model.Id')">Twitter</button>
            </div>
        </div>

        <div class="news-content">
            @Html.Raw(Model.Content)
        </div>

        @if (Model.Images != null && Model.Images.Any())
        {

            var count = Model.Images.Count;

            <div class="gallery">
                <div class="row g-2">
                    @for (int i = 0; i < Math.Min(count, 4); i++)
                    {
                        var img = Model.Images.ElementAt(i);
                        <div class="@(count == 1 ? "col-12"
                                                                                                                                                                                                                                                                                                                                                                                  : "col-6")">
                        <div class="position-relative">
                            <a data-fancybox="gallery-@Model.Id" href="@img.FilePath">
                                <img src="@img.FilePath" class="gallery  rounded shadow-sm"
                                     style="cursor:pointer; object-fit:cover; height:@(count == 1 ? "400px" : "200px"); width:100%;" />
                            </a>

                            @if (i == 3 && count > 4)
                            {
                                <a data-fancybox="gallery" href="@img.FilePath">
                                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-75 text-white fs-3 fw-bold"
                                         style="cursor:pointer;">
                                        +@(count - 3)
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }

                <!-- Hidden extra images for Fancybox -->
                @for (int j = 4; j < count; j++)
                {
                    @if (j <= Model.Images.Count)
                    {
                        var hiddenImg = Model.Images.ElementAt(j);
                        <a data-fancybox="gallery" href="@hiddenImg.FilePath" style="display:none;"></a>
                    }
                }
            </div>
            @*             @foreach (var img in Model.Images)
            {
                <a data-fancybox="gallery" href="@img.FilePath">
                    <img src="@img.FilePath" class="gallery-img" />
                </a>
            } *@
        </div>
                }

        <!-- Video Section -->
        <div class="video-section">
            @foreach (var v in Model.NewsMedias)
            {
                @if (!string.IsNullOrEmpty(@v.MediaUrl))
                {
                    <div class="article-video">
                        <iframe width="80%" height="400"
                                src="@GetEmbedUrl(@v.MediaUrl)"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                        </iframe>
                    </div>
                }
            }
        </div>


        <!-- Videos Section -->
        @*         <div class="video-section">
            @foreach (var v in Model.NewsMedias)
            {
                @if (!string.IsNullOrEmpty(@v.MediaUrl))
                {
                    <div class="article-video">
                        <video controls preload="metadata">
                            <source src="@v.MediaUrl" type="video/mp4" >
                        </video>
                    </div>
                }
            }
        </div> *@
    </div>
    <!-- Right: Comments -->
    <!-- Right: Comments -->
    <div class="popup-right">
        <h5 class="comments-title">Comments</h5>

        <div class="add-comment">
            <div class="comment-input-wrapper">

                <input type="text" id="authorName" name="authorName"
                       class="author-input"
                       data-id="@Model.Id"
                       placeholder="Your name" />

                <div class="comment-row">
                    <textarea id="commentText" name="text"
                              class="comment-textarea"
                              data-id="@Model.Id"
                              rows="2"
                              placeholder="Write a comment..."></textarea>

                    <button data-id="@Model.Id" class="post-comment send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="comments-list" class="comments-list">
            @foreach (var comment in Model.Comments.OrderByDescending(c => c.PostedDate))
            {
                <div class="fb-comment">
                    <img class="avatar" src="/images/default-avatar.png" />

                    <div class="comment-body">
                        <div class="comment-bubble">
                            <span class="name">@comment.AuthorName</span>
                            <p class="text">@comment.Text</p>
                        </div>

                        <div class="comment-meta">
                            <span class="time">@comment.PostedDate.ToString("g")</span> ·
                            <a href="#" class="reply-link">Reply</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>
@functions {
    public string GetEmbedUrl(string VideoUrl)
    {
        string videoUrl = VideoUrl;
        if (!string.IsNullOrEmpty(videoUrl))
        {
            if (videoUrl.Contains("watch?v="))
                videoUrl = videoUrl.Replace("watch?v=", "embed/");
            else if (videoUrl.Contains("youtu.be/"))
                videoUrl = videoUrl.Replace("youtu.be/", "www.youtube.com/embed/");
            else if (videoUrl.Contains("youtube.com/shorts/"))
                videoUrl = videoUrl.Replace("youtube.com/shorts/", "youtube.com/embed/");
        }
        return videoUrl;
    }
}

<script>

</script>